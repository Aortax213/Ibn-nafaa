<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Debug مشغل القرآن — اختبار روابط</title>
<style>
  body{font-family:Cairo, sans-serif;background:#07121a;color:#fff;padding:18px}
  select,input,button{padding:8px 12px;border-radius:8px;border:none;margin:6px}
  button{background:#f0c26a;color:#071217;font-weight:700;cursor:pointer}
  .log{margin-top:12px;background:#03101a;padding:12px;border-radius:8px;height:260px;overflow:auto;font-size:13px;color:#9fd0e6}
  audio{width:100%;margin-top:12px}
  .small{color:#9aa6b3;font-size:13px}
  a.link{color:#ffd166}
</style>
</head>
<body>

<h2>اختبار تشغيل سور القرآن (debug)</h2>
<p class="small">اختر السورة (جرب 001 أولاً) واختر قارئ ثم اضغط "جرّب التشغيل". سيجرب الروابط واحداً تلو الآخر ويعرض لك النتيجة.</p>

<div>
  <label>السورة رقم:</label>
  <input id="surahInput" value="1" style="width:72px" />
  <label>القارئ:</label>
  <select id="reciter">
    <option value="saad">سعد الغامدي</option>
    <option value="juhani">عبد الله الجهني</option>
    <option value="yassin">ياسين الجزائري</option>
  </select>
  <button id="testBtn">جرّب التشغيل</button>
  <button id="openWorking" style="display:none">افتح الرابط الصالح</button>
</div>

<audio id="player" controls></audio>

<div class="log" id="logBox">سجل المحاولات سيظهر هنا...</div>

<script>
const logBox = document.getElementById('logBox');
function log(msg){
  const t = new Date().toLocaleTimeString();
  logBox.innerHTML = `<div>${t} — ${msg}</div>` + logBox.innerHTML;
}

// أنماط روابط مرشحة لكل قارئ (نجرب عدة سيرفرات شهيرة)
const patterns = {
  saad: [
    'https://server8.mp3quran.net/s_gmd/{num}.mp3',
    'https://server11.mp3quran.net/s_gmd/{num}.mp3',
    'https://server8.mp3quran.net/saad_alghamdi/{num}.mp3',
    'https://server11.mp3quran.net/saad_alghamdi/{num}.mp3',
    'https://download.quranicaudio.com/quran/saad_alghamdi/{num}.mp3',
    'https://cdn.islamic.network/quran/audio-surah/128/ar.saad_alghamdi/{num}.mp3'
  ],
  juhani: [
    'https://server10.mp3quran.net/jhn/{num}.mp3',
    'https://server11.mp3quran.net/jhn/{num}.mp3',
    'https://server8.mp3quran.net/abdullah_aljuhani/{num}.mp3',
    'https://server11.mp3quran.net/abdullah_aljuhani/{num}.mp3',
    'https://download.quranicaudio.com/quran/abdullah_aljuhani/{num}.mp3',
    'https://cdn.islamic.network/quran/audio-surah/128/ar.abdullah_aljuhani/{num}.mp3'
  ],
  yassin: [
    'https://server12.mp3quran.net/yassin/{num}.mp3',
    'https://server8.mp3quran.net/yassin/{num}.mp3',
    'https://server11.mp3quran.net/yassin/{num}.mp3',
    'https://download.quranicaudio.com/quran/yassin_aljazaeri/{num}.mp3',
    'https://cdn.islamic.network/quran/audio-surah/128/ar.yassin_aljazairi/{num}.mp3'
  ]
};

// helper لعمل padding 3 خانات
function pad3(n){ return String(n).padStart(3,'0'); }

// نجرب كل رابط واحدا تلو الآخر حتى ينجح
async function tryCandidates(reciterKey, surahNum){
  const player = document.getElementById('player');
  const list = patterns[reciterKey] || [];
  const candidates = [];
  list.forEach(p => {
    candidates.push(p.replace('{num}', pad3(surahNum)));
    candidates.push(p.replace('{num}', String(surahNum)));
  });
  // ازالة التكرار
  const uniq = [...new Set(candidates)];
  log(`عدد الروابط المرشّحة: ${uniq.length}. نبدأ التجربة...`);
  for(let i=0;i<uniq.length;i++){
    const url = uniq[i];
    log(`تجربة (${i+1}/${uniq.length}): ${url}`);
    // نضع المصدر وننتظر حدث canplay أو error أو timeout
    player.src = url;
    player.load();
    const result = await new Promise(resolve => {
      let done = false;
      const onCan = () => { if(!done){ done=true; cleanup(); resolve({ok:true,url}); } };
      const onErr = () => { if(!done){ done=true; cleanup(); resolve({ok:false,url}); } };
      const timer = setTimeout(()=>{ if(!done){ done=true; cleanup(); resolve({ok:false,url,timeout:true}); } }, 7000);
      function cleanup(){
        player.removeEventListener('canplay', onCan);
        player.removeEventListener('canplaythrough', onCan);
        player.removeEventListener('error', onErr);
        clearTimeout(timer);
      }
      player.addEventListener('canplay', onCan);
      player.addEventListener('canplaythrough', onCan);
      player.addEventListener('error', onErr);
    });
    if(result.ok){
      log(`نجح الرابط → ${result.url}`);
      return result.url;
    } else {
      if(result.timeout) log(`انتهت المهلة للرابط → ${result.url}`);
      else log(`فشل تحميل الرابط → ${result.url}`);
      // نجرب التالي
    }
  }
  return null;
}

// زر التجربة
document.getElementById('testBtn').addEventListener('click', async ()=>{
  const sur = Number(document.getElementById('surahInput').value) || 1;
  const rec = document.getElementById('reciter').value;
  log(`بدء اختبار السورة ${sur} للقارئ ${rec} ...`);
  document.getElementById('openWorking').style.display = 'none';
  try{
    const working = await tryCandidates(rec, sur);
    if(working){
      log('تم العثور على رابط صالح. يتم تشغيله الآن إن أمكن.');
      const player = document.getElementById('player');
      player.src = working;
      // أظهر زر لفتح الرابط في تاب جديد
      const openBtn = document.getElementById('openWorking');
      openBtn.style.display = 'inline-block';
      openBtn.onclick = ()=> window.open(working, '_blank');
      try { await player.play(); log('تشغيل ناجح داخل المشغل.'); } catch(e) { log('التشغيل التلقائي منعته متصفحات — اضغط زر "▶" في المشغل لبدء.' ); }
    } else {
      log('لم نتمكن من إيجاد رابط صالح. جرّب قارئ آخر أو انسخ أحد الروابط من السجل وافتحه في تبويب جديد للتحقق.');
    }
  } catch(e){
    log('حدث خطأ أثناء الاختبار: ' + (e.message || e));
    console.error(e);
  }
});
</script>

</body>
</html>
