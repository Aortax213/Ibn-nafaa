<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ูุดุบู ุงููุฑุขู โ ุณุนุฏ ุงูุบุงูุฏู / ุนุจุฏ ุงููู ุงูุฌููู</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#05060a; --panel:#0c1220; --muted:#9aa6b3; --accent:#f0c26a;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Cairo",sans-serif;background:linear-gradient(180deg,#03040a 0%, #071423 100%);color:#fff}
  .container{max-width:960px;margin:28px auto;padding:28px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 40px rgba(0,0,0,0.6)}
  header{text-align:center}
  h1{margin:0;font-size:30px}
  p.lead{color:var(--muted);margin:6px 0 0}
  .controls{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:18px}
  .field{min-width:220px}
  select,button{padding:12px 16px;border-radius:10px;border:0;font-size:16px}
  select{background:#0f1a2b;color:#fff;min-width:240px}
  button{background:var(--accent);color:#071217;font-weight:700;cursor:pointer}
  .player{margin-top:22px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;display:flex;gap:12px;align-items:center}
  .logo{
    width:86px;height:86px;border-radius:12px;flex:0 0 86px;background:linear-gradient(135deg,#071b2a,#102034);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;
    box-shadow:0 8px 30px rgba(0,0,0,0.6)
  }
  .logo img{width:60%;height:60%}
  .logo .pulse{position:absolute;inset:0;border-radius:12px;box-shadow:0 0 40px rgba(240,194,106,0.0);transition:box-shadow .18s linear}
  .meta{flex:1}
  .meta .title{font-weight:700}
  .meta .sub{font-size:13px;color:var(--muted);margin-top:6px}
  audio{width:100%;outline:none}
  .notice{margin-top:12px;color:var(--muted);font-size:13px;text-align:center}
  .footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}

  /* small screens */
  @media(max-width:640px){
    .controls{flex-direction:column;align-items:center}
    select{min-width:92%}
    .logo{width:68px;height:68px}
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>๐ง ูุดุบู ุงููุฑุขู ุงูุงุญุชุฑุงูู</h1>
      <p class="lead">ุณุนุฏ ุงูุบุงูุฏู ูุนุจุฏ ุงููู ุงูุฌููู โ ุงุฎุชุฑ ุงูุณูุฑุฉ ุซู ุงุถุบุท ุชุดุบูู. ุงูุชุทุจูู ูุฌุฑุจ ุฑูุงุจุท ูุชุนุฏุฏุฉ ุชููุงุฆูุงู ูุถูุงู ุงูุชุดุบูู.</p>
    </header>

    <div class="controls" role="region" aria-label="ุนูุงุตุฑ ุงูุชุญูู">
      <div class="field">
        <label class="small">ุงูุณูุฑุฉ</label><br>
        <select id="surahSelect" aria-label="ุงูุณูุฑุฉ"></select>
      </div>

      <div class="field">
        <label class="small">ุงููุงุฑุฆ</label><br>
        <select id="reciterSelect" aria-label="ุงููุงุฑุฆ">
          <!-- ุงูููู ููุง ูุฌุฑุฏ ูุนุฑู ุฏุงุฎูู ุณูุณุชุฎุฏูู ูุงุฎุชูุงุฑ ูุฌููุนุฉ ุฃููุงุท ุฑูุงุจุท -->
          <option value="saad">ุณุนุฏ ุงูุบุงูุฏู</option>
          <option value="juhani">ุนุจุฏ ุงููู ุงูุฌููู</option>
        </select>
      </div>

      <div style="display:flex;align-items:center">
        <button id="playBtn">ุชุดุบูู ุงูุณูุฑุฉ</button>
      </div>
    </div>

    <div class="player" aria-live="polite">
      <div class="logo" title="ุดุนุงุฑู ููุง">
        <!-- ุถุน ููุฌูู ุจุตูุบุฉ PNG ุฃู ุงุณุชุฎุฏู ูุฐุง ุงูุงูููู -->
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='30' fill='%23071b2a' /><path d='M20 42 L20 22' stroke='%23f0c26a' stroke-width='3' stroke-linecap='round'/><path d='M28 42 L28 18' stroke='%23f0c26a' stroke-width='3' stroke-linecap='round'/><path d='M36 42 L36 26' stroke='%23f0c26a' stroke-width='3' stroke-linecap='round'/></svg>" alt="logo">
        <div class="pulse" id="logoPulse"></div>
      </div>

      <div class="meta">
        <div class="title" id="nowTitle">ุฌุงูุฒ ููุชุดุบูู</div>
        <div class="sub" id="nowSub">ุงุฎุชุฑ ุงูุณูุฑุฉ ูุงููุงุฑุฆ ุซู ุงุถุบุท ุชุดุบูู</div>
        <div style="margin-top:10px">
          <audio id="audioPlayer" controls preload="none"></audio>
        </div>
      </div>
    </div>

    <div class="notice" id="notice">ุชุญููู ุงูููุงุฆู...</div>
    <div class="footer">ุตูู ูู ุจุดูู ุงุญุชุฑุงูู โ ููุฌุฏ ูุชุณููู ุงูุงุณุชูุงุน</div>
  </div>

<script>
/*
ุชูุถูุญ ุงููููุงูููุง:
- ูููุฃ ูุงุฆูุฉ ุงูุณูุฑ (1..114).
- ุนูุฏ ุงูุถุบุท ุชุดุบูู ููุชุฌ ูุงุฆูุฉ ุฑูุงุจุท ูุฑุดุญุฉ (candidates) ุจูุงุกู ุนูู ุงููุงุฑุฆ ูุงูุณูุฑุฉ.
- ูุฌุฑุจ ูู ุฑุงุจุท ุชุจุงุนูุง (ูุถุจุท audio.src ูููุชุธุฑ ุญุฏุซ canplay ุฃู error).
- ุฃูู ุฑุงุจุท ูุนูู ูุณุชุฎุฏูู ููุดุบูู.
- ูุฐุง ูุฒูุฏ ุงุญุชูุงููุฉ ุงูุชุดุบูู ุญุชู ูู ุงูุจููุฉ ุนูู ุงูุฎุงุฏู ูุฎุชููุฉ.
*/

// ุนูุงุตุฑ DOM
const surahSelect = document.getElementById('surahSelect');
const reciterSelect = document.getElementById('reciterSelect');
const playBtn = document.getElementById('playBtn');
const audio = document.getElementById('audioPlayer');
const notice = document.getElementById('notice');
const nowTitle = document.getElementById('nowTitle');
const nowSub = document.getElementById('nowSub');
const logoPulse = document.getElementById('logoPulse');

// 1) ุงููุฃ ูุงุฆูุฉ ุงูุณูุฑ ุจุงูุนุฑุจูุฉ (ูุฎุชุตุฑ ุฃุณูุงุก)
const surahNames = [
"ุงููุงุชุญุฉ","ุงูุจูุฑุฉ","ุขู ุนูุฑุงู","ุงููุณุงุก","ุงููุงุฆุฏุฉ","ุงูุฃูุนุงู","ุงูุฃุนุฑุงู","ุงูุฃููุงู","ุงูุชูุจุฉ","ูููุณ",
"ููุฏ","ููุณู","ุงูุฑุนุฏ","ุฅุจุฑุงููู","ุงูุญุฌุฑ","ุงููุญู","ุงูุฅุณุฑุงุก","ุงูููู","ูุฑูู","ุทู",
"ุงูุฃูุจูุงุก","ุงูุญุฌ","ุงููุคูููู","ุงูููุฑ","ุงููุฑูุงู","ุงูุดุนุฑุงุก","ุงูููู","ุงููุตุต","ุงูุนููุจูุช","ุงูุฑูู",
"ูููุงู","ุงูุณุฌุฏุฉ","ุงูุฃุญุฒุงุจ","ุณุจุฃ","ูุงุทุฑ","ูุณ","ุงูุตุงูุงุช","ุต","ุงูุฒูุฑ","ุบุงูุฑ",
"ูุตูุช","ุงูุดูุฑู","ุงูุฒุฎุฑู","ุงูุฏุฎุงู","ุงูุฌุงุซูุฉ","ุงูุฃุญูุงู","ูุญูุฏ","ุงููุชุญ","ุงูุญุฌุฑุงุช","ู",
"ุงูุฐุงุฑูุงุช","ุงูุทูุฑ","ุงููุฌู","ุงูููุฑ","ุงูุฑุญูู","ุงููุงูุนุฉ","ุงูุญุฏูุฏ","ุงููุฌุงุฏูุฉ","ุงูุญุดุฑ","ุงูููุชุญูุฉ",
"ุงูุตู","ุงูุฌูุนุฉ","ุงูููุงูููู","ุงูุชุบุงุจู","ุงูุทูุงู","ุงูุชุญุฑูู","ุงูููู","ุงูููู","ุงูุญุงูุฉ","ุงููุนุงุฑุฌ",
"ููุญ","ุงูุฌู","ุงููุฒูู","ุงููุฏุซุฑ","ุงูููุงูุฉ","ุงูุฅูุณุงู","ุงููุฑุณูุงุช","ุงููุจุฃ","ุงููุงุฒุนุงุช","ุนุจุณ",
"ุงูุชูููุฑ","ุงูุฅููุทุงุฑ","ุงููุทูููู","ุงูุฅูุดูุงู","ุงูุจุฑูุฌ","ุงูุทุงุฑู","ุงูุฃุนูู","ุงูุบุงุดูุฉ","ุงููุฌุฑ","ุงูุจูุฏ",
"ุงูุดูุณ","ุงูููู","ุงูุถุญู","ุงูุดุฑุญ","ุงูุชูู","ุงูุนูู","ุงููุฏุฑ","ุงูุจููุฉ","ุงูุฒูุฒูุฉ","ุงูุนุงุฏูุงุช",
"ุงููุงุฑุนุฉ","ุงูุชูุงุซุฑ","ุงูุนุตุฑ","ุงูููุฒุฉ","ุงูููู","ูุฑูุด","ุงููุงุนูู","ุงูููุซุฑ","ุงููุงูุฑูู","ุงููุตุฑ",
"ุงููุณุฏ","ุงูุฅุฎูุงุต","ุงูููู","ุงููุงุณ"
];
// ุงุถุงูุฉ ุฎูุงุฑุงุช
for(let i=0;i<114;i++){
  const opt = document.createElement('option');
  opt.value = String(i+1);
  opt.textContent = `${surahNames[i]} โ ${i+1}`;
  surahSelect.appendChild(opt);
}

// 2) ุฅุนุฏุงุฏ ููุงุนุฏ ุงูุฑูุงุจุท (ูุงุฆูุฉ ูุฑุดุญุฉ ููู ูุงุฑุฆ)
// ูุญุชูุธ ุจุนุฏุฉ ููุงุนุฏ: cdn.islamic.network (AlQuran CDN)ุ ู mp3quran servers ุดุงุฆุนุฉ.
const patterns = {
  saad: [
    // Islamic Network CDN (ูุฏ ุชููู ูุณููุงุช ูุฎุชููุฉ ููู ูุฌุฑุจ)
    'https://cdn.islamic.network/quran/audio-surah/128/ar.saad_alghamdi/{num}.mp3',
    'https://cdn.islamic.network/quran/audio-surah/128/ar.saad_alghamdi/00{num}.mp3',
    // mp3quran common servers + candidate folders
    'https://server11.mp3quran.net/saad_alghamdi/00{num}.mp3',
    'https://server8.mp3quran.net/saad_alghamdi/00{num}.mp3',
    'https://server11.mp3quran.net/saad_alghamdi/{num}.mp3',
    'https://verse.mp3quran.net/arabic/saad_alghamdi/128/{num}.mp3',
    // fallback to well-known mp3quran folder code (s_gmd)
    'https://server11.mp3quran.net/s_gmd/00{num}.mp3',
    'https://server8.mp3quran.net/s_gmd/00{num}.mp3'
  ],
  juhani: [
    'https://cdn.islamic.network/quran/audio-surah/128/ar.abdullah_aljuhani/{num}.mp3',
    'https://cdn.islamic.network/quran/audio-surah/128/ar.abdullah_aljuhani/00{num}.mp3',
    'https://server11.mp3quran.net/abdullah_aljuhani/00{num}.mp3',
    'https://server8.mp3quran.net/abdullah_aljuhani/00{num}.mp3',
    'https://verse.mp3quran.net/arabic/abdullah_aljuhani/128/{num}.mp3',
    'https://server11.mp3quran.net/abdullah_ajami/00{num}.mp3',
    'https://server8.mp3quran.net/abdullah_ajami/00{num}.mp3'
  ]
};

// Helper: ุจูุงุก ููุงุฆู ุฑูุงุจุท ูุฑุดุญุฉ (format num as 3 digits)
function buildCandidates(reciterKey, surahNum){
  const num3 = String(surahNum).padStart(3,'0');    // 001
  const numPlain = String(surahNum);                // 1
  const arr = patterns[reciterKey] || [];
  // ูุจุฏู {num} ู 00{num} ุญุณุจ ุงููุงูุจ
  const candidates = [];
  arr.forEach(p => {
    candidates.push(p.replace('{num}', num3));
    candidates.push(p.replace('{num}', numPlain));
  });
  // ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
  return [...new Set(candidates)];
}

// ูุธููุฉ: ุชุฌุฑุจุฉ ุฑูุงุจุท ุจุงูุชุชุงุจุน ุญุชู ูุดุชุบู ูุงุญุฏ
function tryPlayCandidates(candidates) {
  return new Promise((resolve, reject) => {
    let idx = 0;
    let tried = 0;
    const maxTry = candidates.length;
    function tryOne() {
      if (idx >= candidates.length) {
        return reject(new Error('no candidate worked'));
      }
      const url = candidates[idx++];
      tried++;
      // ุถุน ูุตุฏุฑ ุงูุตูุช ูุฌุฑุจ
      audio.src = url;
      // force load
      audio.load();
      // ุฅุฐุง ุญุฏุซ canplaythrough => ุตุงูุญ
      const onCan = () => {
        cleanup();
        resolve(url);
      };
      const onErr = () => {
        cleanup();
        // ุฌุฑุจ ุงูุชุงูู ุจุนุฏ ุชุฃุฎูุฑ ุฎููู
        setTimeout(tryOne, 250);
      };
      const onTimeout = () => {
        cleanup();
        setTimeout(tryOne, 250);
      };
      // ุชูุธูู ุงูุฃุญุฏุงุซ
      function cleanup(){
        audio.removeEventListener('canplay', onCan);
        audio.removeEventListener('canplaythrough', onCan);
        audio.removeEventListener('error', onErr);
        clearTimeout(timer);
      }
      audio.addEventListener('canplay', onCan);
      audio.addEventListener('canplaythrough', onCan);
      audio.addEventListener('error', onErr);
      // ุจุนุถ ุงูุฎูุงุฏู ูุฏ ูุง ุชุฑุฌุน error ุจุณุฑุนุฉ => ูุถุน timeout 5s
      const timer = setTimeout(onTimeout, 5000);
    }
    tryOne();
  });
}

// ุชูุงุนู ุงููุงุฌูุฉ
playBtn.addEventListener('click', async () => {
  const surah = parseInt(surahSelect.value, 10);
  const reciter = reciterSelect.value; // 'saad' ุฃู 'juhani'
  notice.textContent = 'ุฌุงุฑู ุชุฌููุฒ ุงูุฑูุงุจุท... ุฌุฑุจูุง ุนุฏุฉ ูุตุงุฏุฑ ูุฒูุงุฏุฉ ุงููุฌุงุญ.';
  nowTitle.textContent = `ุชุญููู: ${surahNames[surah-1]} โ ${surah}`;
  nowSub.textContent = `ุฌุงุฑู ุงุฎุชูุงุฑ ุฃูุถู ุฑุงุจุท ูููุงุฑุฆ ${reciterSelect.options[reciterSelect.selectedIndex].text} ...`;

  // ุจูุงุก ูุฑุดุญูู
  const candidates = buildCandidates(reciter, surah);
  if (candidates.length === 0) {
    notice.textContent = 'ูุง ุชูุฌุฏ ูุตุงุฏุฑ ูุนุฑููุฉ ููุฐุง ุงููุงุฑุฆ.';
    return;
  }

  // ุจุตุฑู: ูุจุถุฉ ููุฌู ุนูุฏ ุงููุญุงููุฉ
  pulseLogo();

  try {
    const goodUrl = await tryPlayCandidates(candidates);
    // ุฅูุฌุงุญ ุงูุชุดุบูู (ูุฏ ุชุญุชุงุฌ ุงููุณุชุฎุฏู ููุถุบุท play ุจุณุจุจ browser autoplay policy)
    audio.src = goodUrl;
    audio.load();
    try { await audio.play(); } catch(e) {
      // ุฅู ููุน ุงููุชุตูุญ ุงูุชุดุบูู ุงูุชููุงุฆู ูุนุฑุถ ุชุนูููุงุช ูููุณุชุฎุฏู
      notice.textContent = 'ุชู ุงุฎุชูุงุฑ ุฑุงุจุท ุตุงูุญ ููู ุงููุชุตูุญ ููุน ุงูุชุดุบูู ุงูุชููุงุฆู. ุงุถุบุท ุฒุฑ ุงูุชุดุบูู ูู ุงููุดุบู ุฃุฏูุงู.';
      nowSub.textContent = `ูุตุฏุฑ: ${goodUrl}`;
      return;
    }
    notice.textContent = `ุงูุขู ูุนูู: ${surahNames[surah-1]} โ ุงููุงุฑุฆ: ${reciterSelect.options[reciterSelect.selectedIndex].text}`;
    nowSub.textContent = `ูุตุฏุฑ: ${goodUrl}`;
    // ุถุน ุชุฃุซูุฑ ูุจุถ ุฏูุฑู ูุน ูู playtimeupdate ูู ุงูุตูุช (ุจูุงุก ุนูู ูู ุถุฑุจุฉ ุจุณูุทุฉ)
    attachPulseOnBeat();
  } catch (err) {
    console.error(err);
    notice.textContent = 'ูู ูุชููู ูู ุฅูุฌุงุฏ ุฑุงุจุท ุตุงูุญ ุชููุงุฆูุงู. ุฃุนุฏ ุงููุญุงููุฉ ุฃู ุฌุฑูุจ ูุงุฑุฆ ุขุฎุฑ.';
    nowSub.textContent = 'ุฌุฑุจ ุชุบููุฑ ุงููุงุฑุฆ ุฃู ุชุญุฏูุซ ุงูุตูุญุฉ.';
  }
});

// ุชุฃุซูุฑ ุจุตุฑู ุณุฑูุน ููููุฌู
function pulseLogo() {
  logoPulse.style.boxShadow = '0 0 40px rgba(240,194,106,0.45)';
  setTimeout(()=> logoPulse.style.boxShadow = '0 0 40px rgba(240,194,106,0.0)', 180);
}

// ูุจุถ ูุน ุงูุฅููุงุน (ุชูุฏูุฑู): ูุณุชุฎุฏู ูุณุชูู ุงูุตูุช ุงููุนูู (analyser) - ููู WebAudio ุชุชุทูุจ user gesture.
// ุณูุญุงูู ุฅูุดุงุก AudioContext ุนูุฏ ุฃูู ุชูุงุนู ูุชุดุบูู visualizer ุจุณูุท.
let audioCtx, analyser, dataArray, sourceNode;
function attachPulseOnBeat() {
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      sourceNode = audioCtx.createMediaElementSource(audio);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);
    }
    // ุชุญุฏูุซ ูุจุถุฉ ูู 150ms
    const step = () => {
      if (!analyser) return;
      analyser.getByteFrequencyData(dataArray);
      // ุญุณุงุจ ูุชูุณุท ุชุฑุฏุฏ ููุฎูุถ (bass)
      let sum = 0;
      for(let i=0;i<20;i++){ sum += dataArray[i]; }
      const avg = sum / 20;
      // ุฅุฐุง avg ุนุงูู ูุณุจูุงู ููุนูู ูุจุถุฉ
      if (avg > 60) {
        logoPulse.style.boxShadow = '0 0 60px rgba(240,194,106,0.5)';
        setTimeout(()=> logoPulse.style.boxShadow = '0 0 40px rgba(240,194,106,0.0)', 120);
      }
      // loop ุทุงููุง ุงููุดุบู ูุนูู
      if (!audio.paused) {
        requestAnimationFrame(step);
      }
    };
    requestAnimationFrame(step);
  } catch(e){
    // ุจุนุถ ุงููุชุตูุญุงุช ุชููุน ุฅูุดุงุก AudioContext ุจุฏูู ุชูุงุนู ุตุฑูุญ
    console.warn('Visualizer not started (AudioContext):', e);
  }
}

// ุนูุฏ ุชุญููู ุงูุตูุญุฉ: ูุนูุฏ ุฑุณุงูุฉ ุฌุงูุฒูุฉ
notice.textContent = 'ุฌุงูุฒ โ ุงุฎุชุฑ ุงูุณูุฑุฉ ูุงููุงุฑุฆ ุซู ุงุถุบุท ุชุดุบูู.';
nowTitle.textContent = 'ุฌุงูุฒ ููุชุดุบูู';
nowSub.textContent = 'ุงููุงุฑุฆ: ุณุนุฏ ุงูุบุงูุฏู / ุนุจุฏ ุงููู ุงูุฌููู - ุชุฌุฑุจุฉ ุฑูุงุจุท ูุชุนุฏุฏุฉ ุชููุงุฆูุงู';
</script>
</body>
</html>
